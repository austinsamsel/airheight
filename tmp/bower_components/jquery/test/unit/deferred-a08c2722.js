module("deferred",{teardown:moduleTeardown}),jQuery.each([""," - new operator"],function(e,t){function r(e){return t?new jQuery.Deferred(e):jQuery.Deferred(e)}test("jQuery.Deferred"+t,function(){expect(23);var e=r();strictEqual(e.pipe,e.then,"pipe is an alias of then"),r().resolve().done(function(){ok(!0,"Success on resolve"),strictEqual(this.state(),"resolved","Deferred is resolved (state)")}).fail(function(){ok(!1,"Error on resolve")}).always(function(){ok(!0,"Always callback on resolve")}),r().reject().done(function(){ok(!1,"Success on reject")}).fail(function(){ok(!0,"Error on reject"),strictEqual(this.state(),"rejected","Deferred is rejected (state)")}).always(function(){ok(!0,"Always callback on reject")}),r(function(e){ok(this===e,"Defer passed as this & first argument"),this.resolve("done")}).done(function(e){strictEqual(e,"done","Passed function executed")}),r(function(e){var t=e.promise(),r=function(){},n=e.promise(r);strictEqual(e.promise(),t,"promise is always the same"),strictEqual(n,r,"non objects get extended"),jQuery.each(t,function(e){jQuery.isFunction(t[e])||ok(!1,e+" is a function ("+jQuery.type(t[e])+")"),t[e]!==r[e]&&strictEqual(r[e],t[e],e+" is the same")})}),jQuery.expandedEach=jQuery.each,jQuery.expandedEach("resolve reject".split(" "),function(e,t){r(function(e){strictEqual(e.state(),"pending","pending after creation");var r=0;for(e.progress(function(e){strictEqual(e,r,"Progress: right value ("+e+") received")}),r=0;3>r;r++)e.notify(r);strictEqual(e.state(),"pending","pending after notification"),e[t](),notStrictEqual(e.state(),"pending","not pending after "+t),e.notify()})})})}),test("jQuery.Deferred - chainability",function(){var e=jQuery.Deferred();expect(10),jQuery.expandedEach=jQuery.each,jQuery.expandedEach("resolve reject notify resolveWith rejectWith notifyWith done fail progress always".split(" "),function(t,r){var n={m:e[r]};strictEqual(n.m(),n,r+" is chainable")})}),test("jQuery.Deferred.then - filtering (done)",function(){expect(4);var e,t,r,n=jQuery.Deferred(),o=n.then(function(e,t){return e*t});o.done(function(e){r=e}),n.done(function(r,n){e=r,t=n}),n.resolve(2,3),strictEqual(e,2,"first resolve value ok"),strictEqual(t,3,"second resolve value ok"),strictEqual(r,6,"result of filter ok"),jQuery.Deferred().reject().then(function(){ok(!1,"then should not be called on reject")}),jQuery.Deferred().resolve().then(jQuery.noop).done(function(e){strictEqual(e,void 0,"then done callback can return undefined/null")})}),test("jQuery.Deferred.then - filtering (fail)",function(){expect(4);var e,t,r,n=jQuery.Deferred(),o=n.then(null,function(e,t){return e*t});o.fail(function(e){r=e}),n.fail(function(r,n){e=r,t=n}),n.reject(2,3),strictEqual(e,2,"first reject value ok"),strictEqual(t,3,"second reject value ok"),strictEqual(r,6,"result of filter ok"),jQuery.Deferred().resolve().then(null,function(){ok(!1,"then should not be called on resolve")}),jQuery.Deferred().reject().then(null,jQuery.noop).fail(function(e){strictEqual(e,void 0,"then fail callback can return undefined/null")})}),test("jQuery.Deferred.then - filtering (progress)",function(){expect(3);var e,t,r,n=jQuery.Deferred(),o=n.then(null,null,function(e,t){return e*t});o.progress(function(e){r=e}),n.progress(function(r,n){e=r,t=n}),n.notify(2,3),strictEqual(e,2,"first progress value ok"),strictEqual(t,3,"second progress value ok"),strictEqual(r,6,"result of filter ok")}),test("jQuery.Deferred.then - deferred (done)",function(){expect(3);var e,t,r,n=jQuery.Deferred(),o=n.then(function(e,t){return jQuery.Deferred(function(r){r.reject(e*t)})});o.fail(function(e){r=e}),n.done(function(r,n){e=r,t=n}),n.resolve(2,3),strictEqual(e,2,"first resolve value ok"),strictEqual(t,3,"second resolve value ok"),strictEqual(r,6,"result of filter ok")}),test("jQuery.Deferred.then - deferred (fail)",function(){expect(3);var e,t,r,n=jQuery.Deferred(),o=n.then(null,function(e,t){return jQuery.Deferred(function(r){r.resolve(e*t)})});o.done(function(e){r=e}),n.fail(function(r,n){e=r,t=n}),n.reject(2,3),strictEqual(e,2,"first reject value ok"),strictEqual(t,3,"second reject value ok"),strictEqual(r,6,"result of filter ok")}),test("jQuery.Deferred.then - deferred (progress)",function(){expect(3);var e,t,r,n=jQuery.Deferred(),o=n.then(null,null,function(e,t){return jQuery.Deferred(function(r){r.resolve(e*t)})});o.done(function(e){r=e}),n.progress(function(r,n){e=r,t=n}),n.notify(2,3),strictEqual(e,2,"first progress value ok"),strictEqual(t,3,"second progress value ok"),strictEqual(r,6,"result of filter ok")}),test("jQuery.Deferred.then - context",function(){expect(7);var e,t,r,n,o={};jQuery.Deferred().resolveWith(o,[2]).then(function(e){return 3*e}).done(function(e){strictEqual(this,o,"custom context correctly propagated"),strictEqual(e,6,"proper value received")}),jQuery.Deferred().resolve().then(function(){return jQuery.Deferred().resolveWith(o)}).done(function(){strictEqual(this,o,"custom context of returned deferred correctly propagated")}),e=jQuery.Deferred(),t=e.then(function(e){return 3*e}),e.resolve(2),t.done(function(e){strictEqual(this,t,"default context gets updated to latest promise in the chain"),strictEqual(e,6,"proper value received")}),r=jQuery.Deferred(),n=r.then(),r.resolve(2),n.done(function(e){strictEqual(this,n,"default context gets updated to latest promise in the chain (without passing function)"),strictEqual(e,2,"proper value received (without passing function)")})}),test("jQuery.when",function(){expect(34),jQuery.each({"an empty string":"","a non-empty string":"some string",zero:0,"a number other than zero":1,"true":!0,"false":!1,"null":null,undefined:void 0,"a plain object":{}},function(e,t){ok(jQuery.isFunction(jQuery.when(t).done(function(r){strictEqual(this,window,"Context is the global object with "+e),strictEqual(r,t,"Test the promise was resolved with "+e)}).promise),"Test "+e+" triggers the creation of a new Promise")}),ok(jQuery.isFunction(jQuery.when().done(function(e){strictEqual(this,window,"Test the promise was resolved with window as its context"),strictEqual(e,void 0,"Test the promise was resolved with no parameter")}).promise),"Test calling when with no parameter triggers the creation of a new Promise");var e,t={};jQuery.when(jQuery.Deferred().resolveWith(t)).done(function(){strictEqual(this,t,"when( promise ) propagates context")}),jQuery.each([1,2,3],function(t,r){jQuery.when(e||jQuery.Deferred(function(){this.resolve(r)})).done(function(t){strictEqual(t,1,"Function executed"+(r>1?" only once":"")),e=t})})}),test("jQuery.when - joined",function(){expect(119);var e={value:1,success:jQuery.Deferred().resolve(1),error:jQuery.Deferred().reject(0),futureSuccess:jQuery.Deferred().notify(!0),futureError:jQuery.Deferred().notify(!0),notify:jQuery.Deferred().notify(!0)},t={value:!0,success:!0,futureSuccess:!0},r={error:!0,futureError:!0},n={futureSuccess:!0,futureError:!0,notify:!0};jQuery.each(e,function(o,i){jQuery.each(e,function(e,u){var s=t[o]&&t[e],c=r[o]||r[e],a=n[o]||n[e],l=s?[1,1]:[0,void 0],f=a&&[n[o],n[e]],d=o+"/"+e,h=i&&jQuery.isFunction(i.promise)?i.promise():void 0,j=u&&jQuery.isFunction(u.promise)?u.promise():void 0;jQuery.when(i,u).done(function(e,t){s?(deepEqual([e,t],l,d+" => resolve"),strictEqual(this[0],h,d+" => first context OK"),strictEqual(this[1],j,d+" => second context OK")):ok(!1,d+" => resolve")}).fail(function(e,t){c?deepEqual([e,t],l,d+" => reject"):ok(!1,d+" => reject")}).progress(function(e,t){deepEqual([e,t],f,d+" => progress"),strictEqual(this[0],f[0]?h:void 0,d+" => first context OK"),strictEqual(this[1],f[1]?j:void 0,d+" => second context OK")})})}),e.futureSuccess.resolve(1),e.futureError.reject(0)});